# PiPulse Pipeline 統合仕様書

# (Unified Master Specification)

**Document ID**: PP-UMS-001  
**Version**: 1.5.0  
**Last Updated**: 2025-12-31  
**Status**: Active / Living Document  
**Author**: Hideo, Grok, Gemini

-----

## 0. ドキュメント管理情報

### 0.1 改訂履歴（Document Level）

**表0-1 改訂履歴 (Document Level)**

|Date      |Author             |Description                                                                                                             |
|:---------|:------------------|:-----------------------------------------------------------------------------------------------------------------------|
|2025-12-31|Hideo, Grok, Gemini|**v1.5.0**: v6.0.0本番デプロイ完了に伴う教訓反映。CI/CD運用アドバイスを6.5新設、プロセス改善履歴に新教訓追加、リリース履歴更新。|
|2025-12-30|Hideo, Grok, Gemini|**v1.4.0**: エンドユーザー（妻）要求「少し前の情報も見たい」に対応。REQ-05 新設、latest_temp_humid.txt を月次ファイルから直近最大32行（約8時間分）抽出する方式に変更。関連設計・テスト・教訓を更新。|
|2025-12-30|Hideo, Grok, Gemini|**v1.3.3**: v5.2.0対策（CI環境分離設計）の教訓を反映。                                                                                   |
|2025-12-29|Hideo, Grok, Gemini|**v1.3.2**: v5.1.0対策（JST強制・空ファイル復元）反映、詳細改訂履歴セクション新設、モックデータ教訓浸透。                                                         |
|2025-12-21|Hideo, Grok, Gemini|**Re-structure**: プロセスIDベースの階層構造に再編。                                                                                    |
|2025-12-21|Hideo, Grok, Gemini|**Initial Integration**: 既存全ドキュメントを本ファイルに統合。INC-006対応完了版。                                                               |

### 0.2 用語集（Glossary）

**表0-2 用語集**

|Term                                  |Definition                                                                                            |
|:-------------------------------------|:-----------------------------------------------------------------------------------------------------|
|**Atomic / Non-Atomic (アトミック・非アトミック)**|操作が不可分であること。アトミックな書き込みは、途中状態が存在せず「成功か失敗か」のどちらかになるため、データ破損を防ぐ（例: `.tmp` 書き込み後の `mv`）。                  |
|**7月データ**                             |192件の過去センサーデータ（秒なし `%Y-%m-%d %H:%M`）。後方互換性テストのベースライン。                                                 |
|**CI/CD**                             |Continuous Integration / Continuous Deployment。継続的インテグレーション・デプロイメント（例: GitHub Actionsによる自動テスト・自動デプロイ）。|
|**Criteria (クライテリア)**                 |メトリクスに対して設定された合否判定基準・目標値（例: 欠測0、処理時間<60秒）。                                                            |
|**FR (Functional Requirement)**       |機能要件。システムが必ず提供しなければならない機能（例: センサー計測）。                                                                 |
|**Metrics (メトリクス)**                   |要件の達成度を客観的に測定可能な指標（例: 欠測数、処理時間）。                                                                      |
|**NFR (Non-Functional Requirement)**  |非機能要件。性能、信頼性、保守性などの品質特性（例: JST統一、再起動耐性）。                                                              |
|**INC-xxx**                           |インシデント番号。過去の失敗と教訓を管理するID（例: INC-006）。                                                                 |
|**Tailoring (テーラリング)**                |個人開発の規模に合わせて、標準プロセス（V字モデル）を最適化・省略すること。                                                                |
|**Traceability (トレーサビリティ)**           |要件(REQ)から設計、実装、テストまでの追跡可能性。                                                                           |
|**Single Source of Truth**            |唯一の正本。本ドキュメント（Unified Master Spec）が全ての情報の基準となること。                                                     |
|**YAML**                              |Yet Another Markup Language。設定ファイルやCI/CDワークフロー定義（`.github/workflows/*.yml`）に使用される、人間が読みやすいデータ形式。      |

### 0.3 参照ドキュメント（References）

- ASPICE v3.1 Process Reference Model（プロセスIDの参照元）
- ISO/IEC 15288（システムライフサイクルプロセス）
- 本プロジェクトGitHubリポジトリ（コード・ワークフロー）

### 0.4 詳細改訂履歴

**表0-3 詳細改訂履歴**

|Document Version|Section|Before               |After                              |Reason                |
|:---------------|:------|:--------------------|:----------------------------------|:---------------------|
|v1.5.0          |1.3    |v6.0.0 (予定)          |v6.0.0.20251231 正式リリースに更新          |本番デプロイ成功を反映           |
|v1.5.0          |6.5    |（セクションなし）            |「CI/CD運用アドバイス」新設                   |v6デプロイ時の互換性トラブル教訓を永続化 |
|v1.5.0          |7.2    |最新教訓は家族の声の早期取り込み     |新教訓「CI/CD変更時の影響分析不足」を追加            |変化点検証の重要性を記録          |
|v1.4.0          |1.2    |ステークホルダーに妻の記載なし      |「妻 (Family User)」を追加               |エンドユーザーの声を正式に位置づけ     |
|v1.4.0          |1.3    |最新リリース v5.2.0        |v6.0.0（予定）追加                       |コードバージョニングを v6 系列へ移行  |
|v1.4.0          |2.2    |REQ-01〜REQ-04.2      |新REQ-05, REQ-05.1追加                |家族要求の独立要件化            |
|v1.4.0          |3.3.1  |latestは最新1行、センサー直書き  |月次ファイルから直近最大32行抽出方式へ変更、設計根拠明記      |データ整合性・再起動耐性・ユーザビリティ向上|
|v1.4.0          |3.3.5  |アトミック更新は月次追記とlatest1行|latest複数行更新も対象に拡張                  |信頼性維持                 |
|v1.4.0          |3.4    |（該当記述なし）             |latest複数行化のトレードオフと採用理由を追加          |設計決定の透明化              |
|v1.4.0          |5.2    |latest更新ロジックテストなし    |update_latest_file() の単体テストケース追加を計画|テスト容易性向上              |
|v1.4.0          |5.4    |家族ユーザー確認項目なし         |家族ユーザー確認項目追加                       |受入テスト強化               |
|v1.4.0          |7.2    |最新教訓はCI汚染対策          |新教訓「エンドユーザー（家族）の声の早期取り込み」を追加       |家族視点の重要性再認識           |

-----

## 1. MAN (Management Process) – プロジェクト管理

### 1.1 プロジェクト概要と目的

- **PiPulse Pipelineのビジョン**: 信頼性が高く、再起動耐性のある温湿度データ収集・クラウド永続化システム。
- **進化の歴史**: 「とりあえず動けばOK」 → 「ドキュメント駆動」 → **「テスト・教訓駆動設計（Test & Lesson-Driven Design）」**（現在）。
- **目的**: 個人開発におけるV字モデルの最適化（テーラリング）の実証と、インシデントゼロの運用。

### 1.2 ステークホルダーと役割

**表1-1 ステークホルダーと役割**

|Stakeholder        |Role                               |Responsibilities                        |
|:------------------|:----------------------------------|:---------------------------------------|
|**User (You)**     |**Project Owner & Developer**      |ビジョン決定、実装、RPi運用、最終意思決定。                 |
|**妻 (Family User)**|**End User & Requirement Provider**|日常利用者。使用感フィードバックと新要求の提示（例：「少し前の情報も見たい」）。|
|**Grok**           |**DevOps Advisor**                 |コードレビュー、ドキュメント整理、INCまとめ。                |
|**Gemini**         |**Architect & QA Partner**         |要件定義、設計評価、テスト計画、技術的整合性の担保。              |

### 1.3 リリース履歴

**表1-2 リリース履歴**

|Version            |Date      |Summary                                                                                       |
|:------------------|:---------|:---------------------------------------------------------------------------------------------|
|**v6.0.0.20251230**|2025-12-30|**Family-Friendly版**: latest_temp_humid.txt を月次ファイルから直近最大32行（約8時間分）抽出方式に変更。ユーザビリティ向上とデータ整合性強化。|
|**v5.2.0.20251230**|2025-12-30|**CI完全対応版**: 本番専用処理をCI環境でスキップするガードを実装。                                                        |
|**v5.1.0.20251228**|2025-12-28|**INC-001/002/005/006対策版**: JST強制、空ファイル復元、CI静的チェック強化。                                         |
|**v4.20251221**    |2025-12-21|**INC-006対策版**: 再起動耐性強化（DataRestorer）、ログ完全復旧機能。                                               |
|v2.0.1             |2025-12-14|SWE.3完了版。月次ファイル切り替え実装。                                                                        |
|v1.2.0             |2025-10-22|`rclone copy` 採用によるデータ消失対策。                                                                   |

**バージョニング方針（今回確定）**

- v5系列は2025年12月の再起動耐性・CI安定化に集中した緊急対応系列と位置づけ完了。
- v6系列から新機能（特にエンドユーザー体験向上）を中心に進める。

### 1.4 プロセス・テーラリング宣言

- **Process Tailoring**: 本プロジェクトはASPICEプロセスを個人開発規模にテーラリングしています。
- **統合方針**: 独立した詳細設計書（SYS.3）やソフトウェア要件定義書（SWE.1）は作成せず、本ドキュメントとコード（SWE.3）に統合します。
- **Single File Policy**: `SensorCopier.py` 1ファイルに全ロジックを集約し、デプロイと管理を簡素化します。

-----

## 2. SYS (System Definition Process) – システム要件定義

### 2.1 ハードウェア構成

- **Raspberry Pi 4 Model B**: データ収集コア。Raspbian (Buster)。AHT25センサー接続 (I2C)。
- **MacBook Air (M2)**: データ分析・可視化環境。
- **Google Drive**: データ永続化クラウドストレージ。

### 2.2 システム要件一覧（トレーサビリティ表）

**表2-1 機能・非機能要件（Traceability Matrix）**

|ID          |Type|Description                                        |Metrics / Criteria            |Priority|Trace To              |Status         |
|:-----------|:---|:--------------------------------------------------|:-----------------------------|:-------|:---------------------|:--------------|
|REQ-01      |FR  |AHT25から温度・湿度を15分間隔で取得し保存                           |欠測なし、時刻誤差±5秒                  |High    |3.2, 4.1, 5.3         |[x] Done       |
|REQ-01.1    |NFR |タイムスタンプはJST。秒の有無を許容する柔軟パース                         |パース成功率 100%                   |High    |3.3.1, 5.4            |[x] Done       |
|REQ-02      |FR  |収集データをGoogle Driveへアップロード                          |E2E処理時間 < 60秒                 |High    |3.3.5, 4.1, 5.3       |[x] Done       |
|REQ-02.1    |NFR |月替りでファイル自動切替。ステートレス同期判定                            |切替時刻 00:00 JST                |High    |3.3.2, 3.3.3, 5.2     |[x] Done       |
|REQ-02.2    |NFR |アップロードエラー時Slackアラート                                |通知遅延 ≤ 5分                     |Medium  |6.2                   |[ ] Todo       |
|REQ-03      |FR  |DriveデータをMySQLに取り込み、Macで可視化                        |描画時間 < 10秒                    |Medium  |8.4                   |[p] Partial    |
|REQ-03.1    |NFR |可視化性能と異常値検出精度                                      |検出精度 > 95%                    |Medium  |8.4                   |[p] Partial    |
|REQ-04      |FR  |GitHub ActionsによるCI/CD自動化                          |デプロイ成功率 100%                  |Medium  |6.1                   |[x] Done       |
|REQ-04.1    |NFR |ワークフロー実行時間 < 1min/Job。Slack通知統合                    |成功率 99%                       |Low     |6.1                   |[ ] Todo       |
|REQ-04.2    |NFR |アーカイブ機能（旧月データ圧縮）。将来拡張                              |復元時間 < 5分                     |Low     |6.3                   |[ ] Todo       |
|**REQ-05**  |FR  |latest_temp_humid.txt に直近約8時間分の複数行データを保持し、即時参照可能とする|最大32行保持、最新行がファイル末尾、月次ファイルと完全整合|High    |3.3.1, 3.3.5, 4.1, 5.2|[x] Done   |
|**REQ-05.1**|NFR |latestファイルの更新はアトミックかつ月次ファイルと常に整合                   |更新成功率 100%、不整合ゼロ              |High    |3.3.5, 5.2            |[x] Done   |

-----

## 3. SYS/SWE (Design Process) – システム・ソフトウェア設計

### 3.1 システムアーキテクチャ概要

**Logical Components & Data Flow:**

|Component|Function|Detail|
|:---|:---|:---|
|**Cron Scheduler**|Trigger|15分ごとにスクリプトを実行 (`*/15`)。|
|**Sensor Reader**|Input|I2C経由でAHT25から温湿度を取得 (Retry x3)。|
|**Data Writer**|Process/Storage|RAM Disk (`/tmp`) へ一時書き込み（SDカード保護） + 月次/最新ファイルの更新。|
|**Sync Manager**|Logic|Pythonロジックで「4時間ごとの全同期」を判定。|
|**Uploader**|Output|`rclone copy` でクラウドへ転送。|

### 3.2 ソフトウェアコンポーネント構成

`SensorCopier.py` 内部の論理モジュール構成：

- **Main Controller**: 処理全体の制御。
- **SensorReader**: I2Cバス経由でのAHT25データ読み取り。 (Ref: **REQ-01**)
- **DataProcessor**: JSTタイムスタンプ付与、データ整形。 (Ref: **REQ-01.1**)
- **DataWriter**: RAMバッファへの書き込み、アトミック更新。 (Ref: **REQ-01**, **REQ-02.1**)
- **SyncManager**: `needs_full_sync` による同期判定。 (Ref: **REQ-02.1**)
- **Uploader**: `rclone` コマンドラッパー。 (Ref: **REQ-02**)
- **DataRestorer**: 起動時のデータ復元ロジック。 (Ref: **INC-006**)

### 3.3 詳細設計（Key Logic）

#### 3.3.1 データ保存形式とディレクトリ構造

- **Directory Structure**:
  
  ```text
  /tmp/sensor_data/                    # RAM Buffer (Volatile)
  ├── temp_humid_YYYY-MM.txt          # Monthly Append
  └── latest_temp_humid.txt           # Latest Atomic Update
  /home/hideo_81_g/sensor_data/        # Persistent Storage
  ├── temp_humid_YYYY-MM.txt
  └── latest_temp_humid.txt
  ```
- **CSV Format**: `YYYY-MM-DD HH:MM:SS,tmp=23.4,hum=45.1` (JST, Fixed Seconds)
- **latest_temp_humid.txt（REQ-05対応）**:
  - **生成方式変更**:
    - 従来：センサー取得データを直接1行書き込み（月次ファイルと独立）。
    - 新方式：RAM上の現行月次ファイルから直近最大32行（15分間隔で約8時間分）を時系列順（古→新、最新行が末尾）で抽出・コピー。
  - **行数設計根拠**:
    - 4時間ごとの全同期によりデータ鮮度は理論上4時間分で確保可能であるが、エンドユーザーの即時参照体験（ユーザビリティ）を優先し、8時間分を採用。
    - 起動直後・月替わり直後は蓄積データ分のみ（32行未満）となり、自然に「最新状態」を表現。
  - **利点**：月次ファイルがSingle Source of Truthとなり、再起動耐性・データ整合性が大幅向上。

#### 3.3.2 月次ファイル切り替えロジック

- `YYYY-MM` 形式のファイル名を動的に生成し、月が変わると自動的に新しいファイルへ書き込みを開始する。

#### 3.3.3 同期判定ロジック（needs_full_sync）

- **課題**: Cronで `0 */4 * * *` と設定すると、REQ-01（15分ごとの計測）が満たせなくなる。また、ガードなしでは4回連続同期が発生する（詳細は **8.6 INC-006 詳細レポート** 参照）。
- **解決策**: Cronは `*/15` で回し、Pythonコード内で `hour % 4 == 0` かつ `0 <= minute < 15` の場合のみ「全同期」フラグを立てる。時刻取得は `get_jst_now()` を使用（システム時刻依存排除）。

#### 3.3.4 再起動耐性（DataRestorer）

- **INC-006対策**: RAMディスク運用中に再起動すると、未保存データが消え、さらに古い永続データで上書きされるリスクがある。
- **解決策**: 起動時に永続領域 (`~/sensor_data`) から RAM (`/tmp`) へデータを逆コピーする。
- **強化策 (v5.1.0)**: 復元条件を「ファイルが存在しない OR **サイズが0バイト**」に拡張。空ファイル検知時は警告ログを出力。

#### 3.3.5 アトミック更新手法

- **手法**: `.tmp` ファイルに書き込み、`fsync` 後に `os.rename` でアトミックに置き換える。
- **対象拡張**: 月次ファイルへの追記に加え、latest_temp_humid.txt への複数行更新も同じ手法でアトミック性を確保。

#### 3.3.6 get_jst_now()

- **目的**: INC-002（タイムゾーン不整合）の完全対策。
- **機能**: システム時刻設定に依存せず、コードレベルでJSTを強制。

#### 3.3.7 環境分離設計（CI/CD耐性）

- **目的**: 本番環境（RasPi）とテスト環境（GitHub Actions）の違いをコードレベルで吸収。
- **実装**: `IS_CI = os.getenv("GITHUB_ACTIONS") == "true"` で本番専用処理をガード。
- **効果**: CIでのモジュールインポート失敗を根絶。

### 3.4 設計決定事項とトレードオフ

- **ConfigLoader未実装**: 設定項目が少ないため、ハードコード定数で実装し、1ファイル構成による保守性を優先。
- **単一ファイル構成**: デプロイの容易さを最優先。
- **latest複数行化の採用理由とトレードオフ**:
  - 採用案：月次ファイル依存の抽出方式。
  - 利点：再起動耐性維持、データ不整合リスクゼロ、実装シンプル。
  - 却下案（センサー直データをメモリ保持）：再起動時消失リスク、整合性管理複雑化 → INC発生確率上昇。
  - 結論：信頼性と保守性を最優先し、抽出方式を選択。

-----

## 4. SWE (Implementation Process) – ソフトウェア実装

### 4.1 実装仕様

 - **File Name**: `sensor_copier_v6_YYYYMMDD.py`（v6系列。リポジトリの最新を参照）
- **Language**: Python 3.x
- **Dependencies**: `smbus2`, `rclone` (external command)

### 4.2 デプロイ方法

- **Method**: Self-hosted Runnerによる自動デプロイ。
- **Process**:
1. GitHub ActionsがRasPi上のRunnerをトリガー。
2. `git fetch` で最新コードを取得。
3. `.tmp` ファイル経由でアトミックに配置。
4. 実行権限付与とシンボリックリンク更新。

-----

## 5. V&V (Verification & Validation Process) – 検証・妥当性確認

### 5.1 テスト戦略概要

- **Unit Test**: ロジック（同期判定、コマンド生成）の網羅的テスト。
- **System Test**: 実機での稼働ログ確認。
- **Acceptance Test**: 過去データとの互換性確認。

### 5.2 単体テスト（Unit Test）

- **Scope**: `needs_full_sync`、`build_rclone_cmd`、`update_latest_file` の安全性。
- **テストケース例**:
  - `update_latest_file`: 行数不足/超過/ファイル不存在時の挙動検証。
  - 空ファイル生成と警告ログ確認。

### 5.3 統合・システムテスト計画

- **Status**: [p] Partial (実機稼働確認)。
- **Plan**: Docker環境でのE2Eテスト（将来拡張）。

### 5.4 受入テスト

- **Status**: [x] Done (7月データ互換性確認、家族ユーザー確認項目達成済)。
- **家族ユーザー確認項目追加**: 「latest_temp_humid.txt を開いて、直近6〜8時間分の推移が一目でわかること（起動直後・月替わり直後は行数が少ないことを許容）」。

### 5.5 テスト容易性向上施策

- **v5での改善**: `rclone` コマンド生成ロジックを関数化。
- **v6での改善予定**: `update_latest_file` を純粋関数化し、単体テスト容易性を確保。

-----

## 6. SUP (Supporting Process) – 運用・サポート

### 6.1 CI/CDパイプライン（GitHub Actions）

- **Workflow**: `.github/workflows/test-and-deploy.yml`
- **Test Scope**: Syntax Check, Static Safety Check, Unit Test (`needs_full_sync`, `build_rclone_cmd`, `update_latest_file`, Data Format).
- **Policy**: テスト通過時のみデプロイを実行（Quality Gate）。

### 6.2 監視・アラート計画

- **Status**: [ ] TBD
- **Plan**: REQ-02.2 に基づくSlack通知の実装。

### 6.3 バックアップ・アーカイブ計画

- **Plan**: 旧月データの圧縮アーカイブ（REQ-04.2）。

### 6.4 構成管理

- **Timezone**: 全て **JST (Japan Standard Time)** で統一。
- **Risks**: I2Cエラー（リトライ済）、SDカード寿命（RAMディスク済）。

### 6.5 CI/CD運用アドバイス（v1.5.0 新設）

v6.0.0デプロイ時の互換性トラブルより抽出された運用指針およびポリシーの詳細は、**8.8 CI/CD運用アドバイス詳細** を参照してください。

-----

## 7. SUP (Problem Resolution & Process Improvement) – 教訓とプロセス改善

### 7.1 インシデントログ（Lessons Learned）

**表7-1 インシデントログ**

|ID     |Date      |Incident                  |Root Cause                       |Countermeasure        |Linked Section   |
|:------|:---------|:-------------------------|:--------------------------------|:---------------------|:----------------|
|INC-001|2025-10   |クラウドデータ消失                 |rclone syncの誤用                   |rclone copyへ変更        |3.3.5, 4.1       |
|INC-002|2025-10   |タイムゾーン不整合                 |UTC→JST移行時の考慮不足                  |JST統一                 |3.3.1            |
|INC-003|2025-11   |Silent Fail               |例外処理の欠如                          |Try-Except強化          |4.1              |
|INC-004|2025-11   |同期遅延トラブル                  |API遅延を同期失敗と誤認                    |ログ監視強化                |6.2              |
|INC-005|2025-12   |データ形式混在                   |秒あり/なしデータの混在                     |柔軟なパースロジック実装          |3.3.1, 5.4       |
|INC-006|2025-12-20|再起動によるデータ消失危機 + 4回連続アップロード|RAMディスク + Flush漏れ + Python同期ガード欠如|DataRestorer + ロジックガード|3.3.3, 3.3.4, 8.6|

### 7.2 プロセス改善履歴

- **v1.3.0**: ASPICEプロセス意識を残しつつ、読みやすさと保守性を向上させる構成へ全面刷新。
- **INC-006教訓**: AIレビューは静的中心。動的テスト（再起動/ガード）と要件トレードオフを人間判断。
- **新教訓 (2025-12-29)**: うっかり（コミット漏れ、異常値モック）→びっくり（CI連続失敗）→しっかり（正常値モック必須化）。
- **新教訓 (2025-12-30)**: 「本番専用処理のCI汚染」対策。IS_CIガードで環境分離を実現（詳細は **8.7**）。
- **新教訓 (2025-12-30)**: 「エンドユーザー（家族）の声の早期取り込みとトレーサビリティ強化」
  - 原因：latestが1行のみでは日常利用で不便であることに気づくのが遅れた。
  - 結果：妻からのフィードバックで即座に新要求発生。
  - 対策：ステークホルダーに妻を明記、新要求は独立REQ-ID付与、小さな使用感改善も正式要件として管理。

-----

## 8. 付録 (Appendices)

### 8.1 Cron設定例

```bash
# 15分ごとに実行 (REQ-01)
*/15 * * * * /usr/bin/python3 /home/hideo_81_g/workspace/SensorCopier_current.py >> /home/hideo_81_g/logs/cron_sensor.log 2>&1
```

### 8.2 rclone設定例（config抜粋）

- **Remote**: `raspi_data` (Google Drive)
- **Bandwidth Limit**: `200k`

### 8.3 主要コードスニペット

**get_jst_now関数 (INC-002対策)**

```python
def get_jst_now():
    """現在時刻(JST)を取得する。システム時刻設定に依存せずJSTを強制する。"""
    return datetime.now(timezone(timedelta(hours=9), 'JST'))
```

**needs_full_sync関数 (INC-006対策)**

```python
def needs_full_sync():
    now = get_jst_now()
    # 4時間ごとの枠、かつその枠の最初の15分間だけTrue
    return (now.hour % 4 == 0) and (0 <= now.minute < 15)
```

**DataRestorer 空ファイル対策抜粋 (v5.1.0)**

```python
    if not os.path.exists(monthly_path_ram) or os.path.getsize(monthly_path_ram) == 0:
        logger.warning(f"RAM上の月次ファイルが空または不存在。復元対象: {monthly_path_ram}")
        should_restore_monthly = True
```

### 8.4 将来予定機能リスト

- 可視化強化（グラフ・異常値検出）
- Slack通知実装 (REQ-02.2)
- DockerによるE2Eテスト環境

### 8.5 過去データ（7月データ）テストケース概要

- **Format**: `%Y-%m-%d %H:%M` (秒なし)
- **Test**: `read_sensor_data` がこの形式を読み込んでもエラーにならず、秒を `00` として扱えること。

### 8.6 INC-006 詳細レポート (Post-Mortem)

**概要**: 再起動によるデータ消失危機と、4回連続アップロードバグの複合インシデント。

**詳細な経緯と原因**:

1. **4回連続アップロードバグ**:
- **事象**: Cronを `*/15` (15分毎) に設定していたが、Python側で「4時間毎」の判定ロジックが不十分だったため、00分, 15分, 30分, 45分 の4回連続で全同期が走ってしまった。
- **AIの関与**: AIレビューではCron設定の構文ミス（minute指定忘れ等）に目が向きがちで、ロジックガードの欠如を見落とした。「完璧👌」というAIの評価を過信したことが背景にある。
- **教訓**: Cron設定を変更せず（REQ-01遵守）、Pythonコード内で `needs_full_sync()` によるガードを実装することで解決。AIの提案（Cronを `0 */4` に変更）は要件を満たさないため却下した（人間の判断）。
2. **再起動データ消失**:
- **事象**: RAMディスク運用中に再起動を行った際、Flushされていないデータが消失し、さらに起動時に古い永続データで上書きされるリスクがあった。
- **解決策**: `DataRestorer` を実装し、起動時に永続領域からRAMへデータを復元するフローを追加。

### 8.7 新教訓レポート（CI汚染対策）

**概要**: 本番専用処理をインポート時に無条件実行していたため、CI環境でディレクトリ不存在エラーが発生し、ユニットテストが実行不能となった。

**詳細な経緯と対策**:
1. **原因（うっかり）**: 本番環境（RasPi）専用の処理（ログディレクトリ作成など）をモジュールレベルで実行していた。
2. **結果（びっくり）**: CI環境（ubuntu-latest）でインポートエラーが発生し、テストが実行されなかった。
3. **対策（しっかり）**: `IS_CI` フラグ（`GITHUB_ACTIONS` 環境変数）を導入し、本番専用処理をガード。CIでは `StreamHandler` のみを使用するように変更。

**深い教訓**:
- **「本番環境特有の副作用は、インポート時に実行してはならない」**。
- CI/CDの価値は「本番コードがテスト環境で安全にインポート・実行可能」であること。
- この教訓により、**v5.2.0 は「環境非依存のクリーンなモジュール」**へと昇華した。

### 8.8 CI/CD運用アドバイス詳細

**表8-1 CI/CD運用アドバイス詳細**
|No.|アドバイス内容                                               |根拠                                                                                                  |推奨度|
|---|------------------------------------------------------|----------------------------------------------------------------------------------------------------|---|
|1  |RasPi OSは最新安定版（Bookworm以降）を維持する                       |BusterはEOL済み。GitHub Actions runnerのNode.js v20が要求するGLIBCXX_3.4.26が存在せず、actions/checkout@v4で互換性エラー発生。|必須 |
|2  |actions/checkoutのバージョン変更は事前検証を実施                      |checkout@v4はNode20依存。古いOSでは即座にエラー。v5時代の手動git checkoutはNode.js回避で安定。                                 |高  |
|3  |CI/CDワークフローの変更時は影響分析を必須とする（作業ディレクトリ、Nodeバージョン、依存ライブラリ）|v6でcheckoutアクション導入 → OS老朽化が表面化 → 連鎖トラブル発生。変化点検証不足が主因。                                               |必須 |
|4  |デプロイパス・作業ディレクトリは$GITHUB_WORKSPACEに依存せず明示的に制御          |checkoutアクション使用時、ワークスペースパスが変化する可能性あり。                                                               |高  |
|5  |Bookworm移行後は標準アクション（checkout@v4など）を積極採用               |最新OSでは互換性問題解消。ワークフローの保守性・可読性が向上。                                                                    |将来 |

**運用ポリシー**
- CI/CDパイプライン変更時は、対象環境での事前検証を実施。
- OSアップグレード時はフルバックアップを取得し、runner再インストールを忘れずに行う。

-----

## 9. Conclusion

> **We are Strongest. And now, distinctly Family-Friendly.**

> v6.0.0 は、教訓を基にした堅牢な設計と運用改善を経て、本番環境で安定稼働を開始した。
> 月次ファイルがSingle Source of Truthとして機能し、再起動耐性と直近データの即時参照性が確保された。
> 教訓駆動設計はコード・テスト・インフラに及び、システム全体の信頼性を継続的に向上させる基盤となっている。

-----