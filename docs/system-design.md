# システム設計 (System Design)

本ドキュメントは、PiPulseパイプラインの全体フロー設計、データフロー、およびシステム設計に関する改善事例を記録します。

**最終更新:** 2025-10-27

---

### 改訂履歴
| 日付 | 変更者 | 変更内容 | 関連 |
|---|---|---|---|
| 2025-10-27 | Hideo (assisted by Gemini/Grok) | データフロー図をMermaidで追加し、v-master-guideline.mdと整合。 | - |
| 2025-10-22 | Hideo (assisted by Gemini) | 初版作成。タイムゾーン移行ミスマッチの事例を記録。 | - |

---

## 設計改善事例: INC-002 タイムゾーン移行ミスマッチ（UTC→JST, 2025-10-22）

### 概要
PiPulseパイプラインのタイムゾーン方針をUTCからJSTに統一する移行作業において、過去のUTCで記録されたJSONデータとの互換性問題が発生し、データ同期処理がサイレントに失敗する事象が発生しました。

### 原因
システム設計段階で、タイムゾーン方針の変更に伴う既存データの互換性（特にISOフォーマットのタイムスタンプに付加されたタイムゾーン情報）に関する考慮が不十分でした。古いUTCのJSONデータが、JST統一後の処理で予期せぬ `TypeError` を引き起こしました。

### 影響
一部のデータ同期処理が停止し、最新のデータがGoogle Driveにアップロードされない期間が発生しました。

### 解決策と予防策
- **解決策**: 過去のUTCで記録されたJSONファイルを削除し、タイムゾーン情報を持たないISOフォーマットの文字列として保存するようにコードを修正しました。また、タイムゾーン情報を剥ぎ取る処理を追加しました。
- **予防策**:
    - **SYS.2ルール**: 今後、システム全体に関わる設定（特にデータ形式やタイムゾーン）を変更する際は、必ず以下の「移行互換性チェックリスト」を作成し、既存データとの整合性を検証することを必須とします。
    - **データフロー図の更新**: 以下のように、データフロー図に「[移行ステップ: UTCクリーンアップ]」のような、データ形式変換やクリーンアップのステップを明示的に追加し、設計段階で互換性問題を可視化します。
      ```mermaid
      graph LR
          Sensor[センサーデータ取得] --> JSON[JSON保存 (ISOタイムスタンプ)]
          JSON --> Cleanup[移行ステップ: UTCクリーンアップ]
          Cleanup --> Sync["データ同期 (JST統一, <1min目標)"]
          Sync --> Drive[Google Driveアップロード]
      ```
    - **API/ライブラリの選定**: `datetime.fromisoformat()` のようなタイムゾーンハンドリングが厳密なAPIを使用する際は、その挙動を十分に理解し、テストケースに含めるようにします。
      ```python
      # テストケースのサンプル
      import datetime
      
      # タイムゾーン情報を持つISO文字列
      ts_with_tz = "2025-10-27T10:00:00+00:00"
      # タイムゾーン情報を持たないISO文字列
      ts_without_tz = "2025-10-27T19:00:00"
      
      # fromisoformat() はタイムゾーン情報を持つ文字列を正しくパースする
      dt_object = datetime.datetime.fromisoformat(ts_with_tz)
      assert dt_object.tzinfo is not None
      ```

*この調整により、システム設計の堅牢性が向上し、[REQ-02]で求められるデータ同期の正確性を保証します。*