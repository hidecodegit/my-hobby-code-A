# 実装 (Implementation)

本ドキュメントは、PiPulseパイプラインの実装に関する情報、コード履歴、および実装改善事例を記録します。

**最終更新:** 2025-10-24

---

### 改訂履歴
| 日付 | 変更者 | 変更内容 | 関連 |
|---|---|---|---|
| 2025-10-24 | Hideo (assisted by Gemini) | レビューに基づく微調整（一貫性/視覚強化）。 | PR #18<br>(v1.2.4参照) |
| 2025-10-23 | Hideo (assisted by Gemini) | rclone Syncデータ削除インシデント事例を追加。 | PR #13 |

---

### INC-001: rclone Syncデータ削除インシデント（2025-10-22）

| 属性 | 値 |
|---|---|
| Severity | Medium |
| Status | Resolved |
| Related Process | SWE.3 |

### 概要
🚨 Google Driveへのデータ同期に `rclone sync` コマンドを使用していた際、ローカル側のファイル削除がGoogle Drive側にも反映され、意図せず過去のデータファイルが消失するインシデントが発生しました。

### 原因
🔍 `rclone sync` コマンドの動作（ソースとデスティネーションを同期させる）を十分に理解せず、テストも不十分なまま運用を開始したため。特に、削除操作の反映に関するテストが欠けていました。

### 影響
Google Drive上の過去のセンサーデータファイルの一部が消失しました。幸い、重要なデータ損失には至りませんでしたが、運用上の信頼性を損なう結果となりました。

### 解決策と予防策
- **解決策**: `rclone sync` の代わりに `rclone copy` コマンドを使用するように変更しました。`copy` コマンドは、ソースからデスティネーションへファイルをコピーするだけで、デスティネーション側のファイルを削除することはありません。

- **予防策**:
    - **SWE.3ルール**: 今後、`rclone` のような外部ツールで同期処理を変更する際は、必ず `--dry-run` オプションを使用して変更内容を事前に確認することを必須とします。
    - **テスト強化**: `pytest` を用いて `rclone` のモックテストを導入し、`sync` や `copy` の挙動（特に削除や上書き）が期待通りであることを自動的に検証するテストケースを追加します。
    - **コード例（テスト用 dry-run）**:
      ```python
      import subprocess
      # rcloneコマンドの構築例
      cmd = ["rclone", "copy", "source", "dest", "--dry-run"]
      subprocess.run(cmd, check=True)
      ```

*この調整により、実装の信頼性が向上し、[REQ-02]で求められるデータ同期の安定性を確保します。*