# [DEPRECATED] SWE.3 ソフトウェア実装（Software Implementation）

> **Note**: 本ドキュメントは更新を停止しました。最新の実装詳細、設計、トレーサビリティについては **[PiPulse_Unified_Master_Spec.md](PiPulse_Unified_Master_Spec.md)** を参照してください。

これは V字モデル SWE.3 の正式成果物です。
`SensorCopier.py` の最終安定版（v2.0.1）の実装詳細、設計決定、および要件とのトレーサビリティを記録します。
`SensorCopier.py` の最新版（v5.20251227）の実装詳細、設計決定、および要件とのトレーサビリティを記録します。

**最終更新**: 2025-12-14（Hideo & Grok 共同承認）
**最終更新**: 2025-12-27

### 改訂履歴

|日付        |変更者         |変更内容                                                                                    |
|----------|------------|----------------------------------------------------------------------------------------|
|2025-12-27|Hideo       |v5.20251227 リリース。INC-001/005対策としてテスト容易性を向上（コマンド生成分離）。                 |
|2025-12-14|Hideo & Grok|SUP.9相当に伴い、変更管理に関する記載を強化。v2.0.1へのアップデートに伴い、実装概要・トレーサビリティ・設計決定を全面更新。教訓セクションにINC-006関連を追加。|
|2025-12-09|Hideo & Grok|SWE.2→SWE.3 トレーサビリティ表を最新コードに完全準拠で追加。フォーマットを他文書と統一。                                      |
|2025-12-09|Hideo & Grok|正式成果物として確定・全体構成を最終化。                                                                    |
|2025-12-08|Hideo       |v1.3.0 完成（.tmp書き込み、状態管理強化）。                                                             |

### 1. 実装概要

|項目     |内容                                                      |
|-------|--------------------------------------------------------|
|実装言語   |Python 3.11+                                            |
|メインファイル|`/home/hideo_81_g/workspace/20251213_SensorCopier_v2.py`|
|メインファイル|`/home/hideo_81_g/workspace/sensor_copier_v5_20251227.py`|
|実行環境   |Raspberry Pi 4（Raspberry Pi OS 64bit）                   |
|実行トリガー |cron により15分間隔（`*/15 * * * *`）                           |
|依存ツール  |rclone, smbus, rsync                                    |
|バージョン  |`__version__ = "2.0.1"`                                 |
|バージョン  |`__version__ = "5.0.0"`                                 |

### 2. 主要機能と対応要件（トレーサビリティ概要）

|要件ID    |実装内容                            |
|--------|--------------------------------|
|REQ-01  |AHT25から15分間隔で温度・湿度取得（JST固定秒付き）  |
|REQ-01.1|秒付き固定出力により7月データ完全互換確保           |
| REQ-02   | `rclone copy --no-traverse` で最新データ即時反映 |
|REQ-02.1|月次ファイル自動切替＋定時全体同期（cron基準・ステートレス）|
|REQ-02.2|未実装（次期マイルストーン）                  |

### 3. トレーサビリティ（SWE.2 → SWE.3）
本表は `SensorCopier.py` の責務範囲のみ記載。  
Mac可視化（REQ-03系）、CI/CD（REQ-04系）は対象外。

|要件ID    |SWE.2 ソフトウェアモジュール|SWE.3 実装箇所（関数／処理）                               |実装ステータス|備考                                       |
|--------|-----------------|------------------------------------------------|-------|-----------------------------------------|
|REQ-01  |`SensorReader`   |`read_sensor_data(i2c_bus)`                     |[x] 完了 |I2Cリトライ＋異常値チェック完全実装                      |
|REQ-01.1|`DataProcessor`  |`read_sensor_data()` 内の `%Y-%m-%d %H:%M:%S` 固定出力|[x] 完了 |柔軟パース不要化 → 7月データ完全互換                     |
|REQ-02  |`Uploader`       |`execute_command()` → 最新ファイル即時アップロード            |[x] 完了 |`--checksum --no-traverse --bwlimit 200k`|
|REQ-02.1|`DataWriter`     |RAMバッファへのシンプル追記 + アトミック上書き（latest）              |[x] 完了 |月替りJST基準                                 |
|REQ-02.1|`DataFlusher`    |`flush_ram_to_persistent()` (rsync -a)          |[x] 完了 |RAM → 永続フラッシュ                            |
|REQ-02.1|`SyncManager`    |`needs_full_sync()` (cron基準: hour % 4 == 0)     |[x] 完了 |ステートレス化（json廃止）                          |
|REQ-02.1|`Uploader`       |`execute_command()` → 永続ディレクトリ全体コピー同期           |[x] 完了 |データ消失ゼロ                                  |
|REQ-02.2|`Alerter`        |未実装（関数なし）                                       |[ ] 未着手|次期マイルストーン（優先度Low）                        |
|-       |`Logger`         |ファイル＋コンソール対応ロギング                                |[x] 完了 |OSローテーション任せ                              |
|-       |`ConfigLoader`   |ハードコード定数で代替                                     |[x] 完了 |SWE.2設計通り初期フェーズは不要                       |

### 4. ファイル構成と出力形式
```
/tmp/sensor_data/                    # RAMバッファ（揮発性・高速）
├── temp_humid_2025-12.txt          # 月次追記
└── latest_temp_humid.txt           # 即時反映用

/home/hideo_81_g/sensor_data/        # 永続ディレクトリ（停電耐性）
├── temp_humid_2025-12.txt
└── latest_temp_humid.txt
```
出力フォーマット（固定）：  
`2025-12-09 23:45:00,tmp=23.4,hum=45.1`

### 5. 重要な設計・実装決定

| 決定事項                             | 変更前（v1.3.0）                  | 変更後（v2.0.1）                                      | 理由・教訓対応                                                                 |
|--------------------------------------|-----------------------------------|-------------------------------------------------------|---------------------------------------------------------------------------------|
| RAMバッファ + 定期フラッシュ方式導入 | /tmp直書き（揮発性）             | RAMバッファ（/tmp/sensor_data） + 4時間ごとrsyncフラッシュ（永続ディレクトリ） | INC-006根本対策<br>停電によるデータ消失防止 + SDカード寿命抑制。停電時最悪欠損4時間分に限定。 |
| 全体同期ステートレス化（json廃止）   | last_full_sync.jsonで状態保持     | cron基準 (hour % 4 == 0) で判定                      | 運用体感向上 + 堅牢性強化<br>json破損リスク排除、タイミング予測容易に。         |
| rclone copy 完全維持                 | rclone copy使用                   | 変更なし（維持）                                      | INC-001教訓再確認<br>sync使用による過去データ抹殺リスク永遠排除。               |
| ファイル書き込みの原子性強化         | .tmp経由（月次） + 直書き（latest） | latestは.tmp + fsync + rename、月次は追記 + fsync    | クラッシュ時破損防止<br>RAM上でも安全確保。                                     |
| 手動復旧作業での運用ミス教訓         | なし                              | 新規記載                                              | 変更管理の運用適用（SUP.9相当）<br>grep時制限ミス・cp上書きミスによる一時欠損発生。<br>予防策: データ操作前バックアップ必須、変更後head/tail確認。 |

### 6. 現行制限と次期対応予定
-| 制限事項                         | 対応予定 |
-|----------------------------------|----------|
-| Slackアラート未実装（REQ-02.2） | 2026-01マイルストーン |
-| 設定の外部ファイル化             | 必要になった時点で `ConfigLoader` 分離 |

-### 7. 結論 — SWE.3 完了宣言
-> **SensorCopier.py v1.3.0 は全必須要件（REQ-01/01.1/02/02.1）を100%満たし、教訓（INC-xxx）を完全に反映した生産品質の実装である。**  
-> これにより **SWE.3 ソフトウェア実装プロセスは正式に完了**。
+|制限事項                    |対応予定          |
+|------------------------|--------------|
+|Slackアラート未実装（REQ-02.2）  |2026-01マイルストーン|
+|設定の外部ファイル化（ConfigLoader）|必要時分離         |
+|UTC統一                   |国際運用時検討       |
+|復旧作業専用スクリプト             |次インシデント時作成    |
+
+### 7. 結論 — SWE.3 完了宣言（v2.0.1版）
+
+> **SensorCopier.py v2.0.1 は全必須要件を100%満たし、INC-006の教訓を完全に反映・復旧した生産品質の実装である。**  
+> **2025年12月データは完全に復旧・継続中。**  
+> これにより **SWE.3 ソフトウェア実装プロセスは最新版として正式に完了**。