# SWE.3 ソフトウェア実装（Software Implementation）
これは V字モデル SWE.3 の正式成果物です。
`SensorCopier.py` の最終安定版（v1.3.0）の実装詳細、設計決定、および要件とのトレーサビリティを記録します。

**最終更新**: 2025-12-09（Hideo & Grok 共同承認）

### 改訂履歴
| 日付           | 変更者             | 変更内容 |
|----------------|--------------------|----------|
| 2025-12-09     | Hideo & Grok       | SWE.2→SWE.3 トレーサビリティ表を最新コードに完全準拠で追加。フォーマットを他文書と統一。 |
| 2025-12-09     | Hideo & Grok       | 正式成果物として確定・全体構成を最終化。 |
| 2025-12-08     | Hideo              | v1.3.0 完成（.tmp書き込み、状態管理強化）。 |

### 1. 実装概要
| 項目                | 内容 |
|---------------------|------|
| 実装言語            | Python 3.11+ |
| メインファイル      | `/home/hideo_81_g/SensorCopier.py` |
| 実行環境            | Raspberry Pi 4（Raspberry Pi OS 64bit） |
| 実行トリガー        | cron により15分間隔（`*/15 * * * *`） |
| 依存ツール          | rclone, smbus2 |
| バージョン          | `__version__ = "1.3.0"` |

### 2. 主要機能と対応要件（トレーサビリティ概要）
| 要件ID   | 実装内容 |
|----------|----------|
| REQ-01   | AHT25から15分間隔で温度・湿度取得（JST固定秒付き） |
| REQ-01.1 | 秒付き固定出力により7月データ完全互換確保 |
| REQ-02   | `rclone copy --no-traverse` で最新データデータ即時反映 |
| REQ-02.1 | 月次ファイル自動切替＋2時間ごと全体同期（last_full_sync.json管理） |
| REQ-02.2 | 未実装（次期マイルストーン） |

### 3. トレーサビリティ（SWE.2 → SWE.3）
本表は `SensorCopier.py` の責務範囲のみ記載。  
Mac可視化（REQ-03系）、CI/CD（REQ-04系）は対象外。

| 要件ID   | SWE.2 ソフトウェアモジュール         | SWE.3 実装箇所（関数／処理）                                 | 実装ステータス | 備考 |
|----------|--------------------------------------|-------------------------------------------------------------|----------------|------|
| REQ-01   | `SensorReader`                       | `read_sensor_data(i2c_bus)`                                 | [x] 完了       | I2Cリトライ＋異常値チェック完全実装 |
| REQ-01   | `cron` スケジューラ                  | cron 外部設定（`*/15 * * * *`）                             | [x] 完了       | システムレベルで実現 |
| REQ-01.1 | `DataProcessor`                      | `read_sensor_data()` 内の `%Y-%m-%d %H:%M:%S` 固定出力       | [x] 完了       | 柔軟パース不要化 → 7月データ完全互換 |
| REQ-02   | `Uploader`                           | `run_rclone()` → 最新ファイル即時アップロード               | [x] 完了       | `--checksum --no-traverse --bwlimit 200k` |
| REQ-02.1 | `DataWriter`                         | `get_monthly_filepath()` + `.tmp` 経由原子書き込み          | [x] 完了       | 月替りJST基準 |
| REQ-02.1 | `SyncManager`                        | `last_full_sync.json` による2時間ごと全体同期判定           | [x] 完了       | ファイル破損時も安全に同期実行 |
| REQ-02.1 | `Uploader`                           | `run_rclone()` → 全体同期（`copy SENSOR_DATA_DIR`）         | [x] 完了       | データ消失ゼロ |
| REQ-02.2 | `Alerter`                            | 未実装（関数なし）                                          | [ ] 未着手     | 次期マイルストーン（優先度Low） |
| -        | `Logger`                             | ファイル＋コンソール対応ロギング                           | [x] 完了       | OSローテーション任せ |
| -        | `ConfigLoader`                       | ハードコード定数で代替                                      | [x] 完了       | SWE.2設計通り初期フェーズは不要 |

### 4. ファイル構成と出力形式
```

/tmp/sensor_data/
├── temp_humid_2025-12.txt          # 月次追記
├── latest_temp_humid.txt           # 即時反映用
└── last_full_sync.json             # {“last_sync”: “2025-12-09T23:45:00”, “version”: “1.3.0”}

```
出力フォーマット（固定）：  
`2025-12-09 23:45:00,tmp=23.4,hum=45.1`

### 5. 重要な設計・実装決定
| 決定事項                             | 理由・教訓対応 |
|--------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`rclone sync` → `copy` 完全移行**     | **INC-001対応（データ消失リスク排除）**<br>過去に`rclone sync`の仕様誤解により、Google Drive上のデータが意図せず削除されるインシデントが発生。これを教訓に、ソースから宛先への一方的なコピーのみを行う`rclone copy`に完全移行し、データの安全性を確保した。<br><br>**予防策 (SWE.3ルール):**<br>・`rclone`等の外部同期ツール使用時は、本番適用前に必ず`--dry-run`で影響範囲を確認する。<br>・`pytest`で`rclone`コマンドの挙動（特に削除や上書き）をモックテストし、CIで自動検証する。 |
| **`.tmp` 経由の原子書き込み**            | **排他制御・クラッシュ時破損防止**<br>センサーデータ書き込み中にスクリプトがクラッシュした場合でも、ファイルが破損しないように、一度`.tmp`ファイルに書き込み、完了後にリネームする方式を採用。これにより、書き込み処理の原子性（アトミック性）を保証する。 |
| **`last_full_sync.json` で状態保持**     | **再起動後も正確な同期間隔維持**<br>2時間ごとの全体同期の最終実行時刻を外部ファイルに記録することで、Raspberry Piの再起動後も正確な同期間隔を維持できるようにした。ファイルが破損していても安全に初期化されるフォールバック処理も実装済み。 |
| **I2Cエラー3回で自動再初期化**           | **一時的バスハングによる欠測ゼロ化**<br>センサーとのI2C通信で一時的なハングアップが発生しても、3回のリトライと再初期化処理を挟むことで、システムの安定性を向上させ、データ欠測のリスクを最小限に抑える。 |

### 6. 現行制限と次期対応予定
| 制限事項                         | 対応予定 |
|----------------------------------|----------|
| Slackアラート未実装（REQ-02.2） | 2026-01マイルストーン |
| 設定の外部ファイル化             | 必要になった時点で `ConfigLoader` 分離 |

### 7. 結論 — SWE.3 完了宣言
> **SensorCopier.py v1.3.0 は全必須要件（REQ-01/01.1/02/02.1）を100%満たし、教訓（INC-xxx）を完全に反映した生産品質の実装である。**  
> これにより **SWE.3 ソフトウェア実装プロセスは正式に完了**。