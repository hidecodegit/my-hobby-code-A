# SWE.2 ソフトウェアアーキテクチャ設計書
**プロジェクト**：PiPulse Pipeline
**最終更新**：2025-12-07（Hideo & Gemini 共同確定）
**トレース元**：docs/system_architecture.md (SYS.2)

### 改訂履歴
| 日付 | 変更者 | 変更内容 |
|---|---|---|
| 2025-12-07 | Hideo, Gemini | コンポーネント図をリスト形式に変更し、可読性を向上。Grokとの議論を反映し、設計トレードオフのセクションを追加。 |

### 1. 目的
本ドキュメントは、SYS.2で定義された「Raspberry Pi 4」コンポーネント（`SensorCopier.py`）の内部ソフトウェアアーキテクチャを定義する。
ソフトウェアを論理的なモジュールに分割し、各モジュールの責務とインターフェースを定義することで、SWE.3（詳細設計・実装）へのインプットとすることを目的とする。

### 2. ソフトウェアコンポーネント図
`SensorCopier.py` を構成する主要な論理モジュールと、それらの間のデータフローを示す。
`Main Controller`が全体の処理フローを制御し、各モジュールを呼び出します。

- **`Main Controller`** (処理全体の制御)
    - → `ConfigLoader`: 実行前に設定を読み込む。
    - → `SensorReader`: センサーからデータを読み取る。
        - → `DataProcessor`: 読み取ったデータを加工する。
            - → `DataWriter`: 加工したデータをファイルに書き込む。
                - → `Uploader`: 最新ファイルをアップロードする。
    - → `SyncManager`: 定期的な全体同期を管理する。
        - → `Uploader`: データディレクトリ全体をアップロードする。
    - → `Logger`: (各モジュールから) 実行ログを記録する。
    - → `Alerter`: (`Uploader`から) 失敗時に通知を行う。

### 3. モジュール定義
各モジュールの責務と、理想的なインターフェース、そして現状の実装との差分を定義する。

| モジュール名 | 対応要件 | 責務（何をするか） | 主要インターフェース（SWE.3で実装） | 現状実装との差分・理由（設計トレードオフ） |
|---|---|---|---|---|
| `ConfigLoader` | - | 設定の一元管理（将来INI/YAML対応） | `load_config() -> dict` | **理想形**。現在はモジュール化せずハードコード定数で実現。<br>理由：初期フェーズでは変更頻度が低く、1ファイル構成による起動速度・保守性を優先。将来環境移行時（例：別のRPiへ移設）に独立化予定。 |
| `SensorReader` | REQ-01 | I2Cバスを経由してAHT25センサーから温度・湿度データを読み取る。 | `read_sensor_data() -> str or None` | 現行コードと完全一致 |
| `DataProcessor` | REQ-01.1 | センサーデータにJSTのタイムスタンプを付与するなど、データを加工・整形する。 | `attach_jst_timestamp()` | 現行コードでは`main`関数内にインライン実装。将来的に分離推奨。 |
| `DataWriter` | REQ-02, REQ-02.1 | 処理されたデータを月次ファイルと最新データファイルに書き込む。排他制御も担当。 | `append_to_monthly_file()`, `overwrite_latest_file()` | 現行コードとほぼ一致 |
| `Uploader` | REQ-02, REQ-02.1 | `rclone` を使用して、指定されたファイルやディレクトリをGoogle Driveにアップロードする。 | `rclone_copy() -> bool` | 現行コードと完全一致 |
| `SyncManager` | REQ-02.1 | 全体同期が必要かどうかを判断し、同期後の状態を更新する。 | `needs_full_sync()`, `update_full_sync_state()` | 現行コードと完全一致 |
| `Alerter` | REQ-02.2 | (将来実装) 同期失敗などのイベント発生時にSlackへ通知を送信する。 | `slack_alert(message: str)` | 未実装 |
| `Logger` | - | アプリケーションの実行状況やエラー情報をログとして記録する。 | `log_error()`, `log_info()` | 現行コードとほぼ一致 |

### 4. トレーサビリティ（SYS.2 → SWE.2）

本ドキュメントは、`system_architecture.md` (SYS.2) で定義された論理コンポーネントを、本ドキュメントで定義するソフトウェアモジュール (SWE.2) に分解したものです。

| SYS.2 実装コンポーネント | SWE.2 対応モジュール |
|---|---|
| AHT25センサー読み取り | `SensorReader` |
| 柔軟タイムスタンプパース | `DataProcessor` |
| rclone copy同期 | `Uploader` |
| 月次JSON自動切替 + JST統一 | `DataWriter`, `SyncManager` |
| Slackアラート（将来拡張） | `Alerter` |

### 5. 設計決定とトレードオフ（Design Decisions & Trade-offs）
| 決定事項 | 選択した理由 | 将来の対応予定 |
|---|---|---|
| **ConfigLoaderを未実装** | 現時点の設定項目は10個未満かつ変更頻度が低いため、1ファイル構成による簡潔さを優先。 | 設定項目が複雑化、または複数環境への展開が必要になった時点でモジュールとして分離する。 |
| **現在は単一ファイル構成** | `SensorCopier.py`という単一ファイルで実装。起動時間、デバッグの容易性、cron実行のシンプルさを最優先。 | `pytest`等による本格的な単体テスト導入時に、責務に応じて物理的なファイル分割を検討する。 |
| **Alerterは未実装** | コア機能（データ収集・同期）の実装と安定化が最優先。障害通知は「次に実装する機能」として明確に位置づけ。 | コア機能の安定稼働が確認された後、次のマイルストーンとして実装予定。 |