# SYS.2 システムアーキテクチャ設計書
**プロジェクト**：PiPulse Pipeline  
**最終更新**：2025-12-07（Hideo & Gemini 共同確定）  
**トレース元**：docs/system_requirements.md（全REQ対応）

### 改訂履歴
| 日付         | 変更者               | 変更内容                                           |
|--------------|----------------------|----------------------------------------------------|
| 2025-12-07   | Hideo & Gemini       | Mermaid図をリスト形式に変更し、可読性を向上。セクション番号の重複を修正。 |
| 2025-12-06   | Hideo, Grok, Gemini  | 用語集を追加し、ドキュメント全体の書式を最終FIX。    |
| 2025-12-06   | Hideo, Grok, Gemini  | 全ドキュメントと整合性を取るFIX。ハードウェア名を`RPi 4`に統一。 |
| 2025-12-06   | Hideo, Grok, Gemini  | 旧system-design.mdをSYS.2正式成果物に昇格。        |

### 1. 用語集（本ドキュメント固有）
- **システムコンテキスト図**: システムとその外部環境（ユーザー、他システム等）との境界と相互作用を定義する図。
- **論理アーキテクチャ図**: システムを構成する主要な論理コンポーネント（機能部品）と、それらの間のデータフローや連携を示す図。

### 2. システムコンテキスト図
システム全体と、それを取り巻く外部要素との関係性を示します。

- **`AHT25 センサー`**: `Raspberry Pi 4` がI2C経由でデータを読み取る物理デバイス。
- **`Raspberry Pi 4`**: センサーデータを収集・処理し、`Google Drive`へアップロードする中核コンポーネント。
- **`Google Drive`**: `Raspberry Pi 4` からのデータを受け取るクラウドストレージ。
- **`MySQL`**: `Google Drive` のデータを格納し、分析の基盤となるデータベース。
- **`Mac 可視化スクリプト`**: `MySQL` のデータを読み取り、グラフとして可視化する。
- **`Slack`**: (将来拡張) `Raspberry Pi 4` からの通知を受け取る。

### 3. 論理アーキテクチャ
`Raspberry Pi 4` 上で実行される `SensorCopier.py` の内部処理フローを示します。

- **`cron` (スケジューラ)**
    - → `SensorCopier.py` を15分間隔で起動する。
- **`SensorCopier.py` (メインスクリプト)**
    - → `AHT25センサー読み取り`: I2C経由でセンサーデータを取得する。
    - → `柔軟タイムスタンプパース`: 秒の有無が混在するタイムスタンプを処理する (INC-005対応)。
    - → `ファイル書き込み`: 処理後のデータを最新ファイルと月次ファイルに書き込む (JST統一, INC-002対応)。
        - → `Google Drive` へデータを出力する。
    - → `rclone copy同期`: 書き込んだファイルを `Google Drive` へアップロードする (INC-001対応)。
        - → (失敗時) `Slackアラート` を送信する (REQ-02.2 将来拡張)。

### 4. 要件トレーサビリティ（SYS.1 → SYS.2）

|対応要件    |実装コンポーネント                           |教訓適用   |
|--------|-----------------------------------|-------|
|REQ-01  |AHT25センサー読み取り + cron               |-      |
|REQ-01.1|柔軟タイムスタンプパース                       |INC-005|
|REQ-02  |rclone copy同期                      |INC-001|
|REQ-02.1|月次JSON自動切替 + JST統一                 |INC-002|
|REQ-02.2|Slackアラート（将来拡張）                    |-      |
|REQ-03  |Google Drive → MySQL sensor_data_db|-      |
|REQ-03.1|可視化スクリプト（192件<10秒）                 |-      |
|REQ-04  |GitHub Actions CI/CD               |-      |
|REQ-04.2|旧月データアーカイブ（将来拡張）                   |-      |

### 5. 教訓適用状況（詳細は docs/lessons-learned.md 参照）

|INC番号  |内容           |本設計での対策              |
|-------|-------------|---------------------|
|INC-001|rclone sync誤用|rclone copy採用、データ損失ゼロ|
|INC-002|タイムゾーン移行ミス   |すべてのタイムスタンプをJSTに統一   |
|INC-005|データ形式混在      |柔軟パース関数で秒有無両対応       |