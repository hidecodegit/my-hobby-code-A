# 品質保証計画 (Quality Assurance Plan)

本ドキュメントは、PiPulseパイプラインの品質保証計画、品質メトリクス、監査計画、およびQA改善事例を記録します。

**最終更新:** 2025-10-26

---

### 改訂履歴
| 日付 | 変更者 | 変更内容 | 関連 |
|---|---|---|---|
| 2025-10-26 | Hideo (assisted by Gemini) | 同期遅延のトラブルシュート事例(INC-004)を追記。 | - |
| 2025-10-24 | Hideo (assisted by Gemini) | レビューに基づく微調整（一貫性/視覚強化）。 | PR #18<br>(v1.2.4参照) |
| 2025-10-23 | Hideo (assisted by Gemini) | json状態更新Silent Fail事例を追加。 | PR #13 |

---

### クイックリード
1.  QA改善事例: json状態更新Silent Fail。
2.  原因: 例外処理不備。
3.  対策: `try-except`とテスト強化。

### INC-004: 同期遅延のトラブルシュート（2025-10-26）

| 属性 | 値 |
|---|---|
| Severity | Low |
| Status | Resolved |
| Related Process | SUP.1, SWE.3 |

#### 概要
`last_full_sync.json`のタイムスタンプが古いという事象が報告されたが、`software-specs.md`で定義されたcronログ（`cron_sensor.log`）を調査した結果、cronジョブ自体は正常に実行されていることが確認された。根本原因はGoogle Drive APIの一時的な遅延である可能性が高いと判断された。

#### 教訓と予防策
- **ログの重要性**: cronの出力をファイルにリダイレクトしておくことで、問題の切り分け（RPi側の問題か、外部サービス側の問題か）が迅速に行えることが証明された。
- **QAプロセス**: [REQ-02]の`<1min`目標達成を監視するため、定期的にcronログを確認し、"全体のコピー同期" のようなキーワードでgrepするプロセスをQA活動に含める。
- **テストケース**: 「`last_full_sync.json`が古い場合に、まず`cron_sensor.log`を確認してRPi側の実行成否を判断する」という手順をテストケースに追加する。

### INC-003: json状態更新Silent Fail（2025-10-23）

| 属性 | 値 |
|---|---|
| Severity | Medium |
| Status | Resolved |
| Related Process | SUP.1 |

### 概要
🚨 システムの状態を記録するJSONファイル（`last_full_sync.json`）の更新処理において、ファイル書き込み時の例外処理が不十分だったため、JSONファイルの破損や書き込み失敗がサイレントに発生し、結果として全体同期のトリガーが遅延するバグが発生しました。

### 原因
🔍 `json.dump` 処理が失敗した場合の例外（例: ディスクフル、パーミッションエラー）が適切にキャッチされておらず、エラーがログにも出力されないまま処理が続行されていました。これにより、JSONファイルが破損した状態のまま放置され、次回の読み込み時に `json.JSONDecodeError` が発生しても、それが適切にハンドリングされていませんでした。

### 影響
全体同期のトリガーが期待通りに動作せず、Google Drive上のデータが最新の状態に保たれない期間が発生しました。

### 解決策と予防策
- **解決策**: `json.dump` 処理を `try-except` ブロックで囲み、書き込み失敗時にエラーをログに出力するように修正しました。また、`json.JSONDecodeError` が発生した場合も、それを適切にハンドリングし、ログに出力するようにしました。

- **予防策**:
    - **SUP.1ルール**: 重要な状態管理ファイル（JSONなど）の読み書き処理については、必ずエンドツーエンドテストを実施し、ファイル破損や書き込み失敗といったエッジケースを網羅するようにします。
    - **テスト強化**: `pytest` を用いて、JSONファイルの読み書きシナリオ（正常系、ファイル破損、書き込み失敗）をシミュレートするテストケースを追加し、80%以上のカバレッジを目標とします。
    - **ログ強化**: 状態管理ファイルの読み書きに関するログレベルを `INFO` 以上とし、異常発生時には `ERROR` レベルで詳細な情報を出力するようにします。**Tips:** ログレベル INFO以上、ERRORで詳細出力。

*この調整により、QA計画の堅牢性が向上し、[REQ-02]で求められる迅速なデータ更新の信頼性を確保します。*

### QA改善事例リスト (将来拡張用)
| 事例ID | 日付 | プロセス | 概要 |
|---|---|---|---|
| INC-001 | 2025-10-22 | SWE.3 | rclone Syncデータ削除インシデント |
| INC-002 | 2025-10-22 | SYS.2 | タイムゾーン移行ミスマッチ |
| INC-003 | 2025-10-23 | SUP.1 | json状態更新Silent Fail |