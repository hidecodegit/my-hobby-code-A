name: Test and Deploy SensorCopier v6

on:
  push:
    branches: [ main ]
    paths:
      - 'sensor_copier_v6_*.py'
      - 'tests/**'
  workflow_dispatch:
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install smbus2 for mock
        run: pip install smbus2

      - name: Run unit tests
        run: python -m unittest discover -s tests -v

  deploy:
    needs: test
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3

      - name: Get script filename
        id: script
        run: echo "filename=$(ls sensor_copier_v6_*.py)" >> $GITHUB_OUTPUT

      - name: Deploy on RasPi
        run: |
          SCRIPT_FILENAME=${{ steps.script.outputs.filename }}
          TARGET_DIR="/home/hideo_81_g/workspace"
          LOG_DIR="/home/hideo_81_g/logs"
          mkdir -p "$TARGET_DIR" "$LOG_DIR"

          cp "$SCRIPT_FILENAME" "$TARGET_DIR/$SCRIPT_FILENAME.tmp"
          chmod +x "$TARGET_DIR/$SCRIPT_FILENAME.tmp"
          mv "$TARGET_DIR/$SCRIPT_FILENAME.tmp" "$TARGET_DIR/$SCRIPT_FILENAME"

          ln -sf "$SCRIPT_FILENAME" "$TARGET_DIR/SensorCopier_current.py"

          echo "$(date): Deployed $SCRIPT_FILENAME (unittest)" >> "$LOG_DIR/deploy.log"
